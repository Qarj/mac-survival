# M1 workarounds

## Install Chromium

https://linguinecode.com/post/how-to-fix-m1-mac-puppeteer-chromium-arm64-bug

On Mac M1, need to install chromium separately and not with npm / yarn

```sh
brew install chromium
.
==> Installing Cask chromium
==> Moving App 'Chromium.app' to '/Applications/Chromium.app'
==> Linking Binary 'chromium.wrapper.sh' to '/opt/homebrew/bin/chromium'
🍺  chromium was successfully installed!
.
which chromium
.
/opt/homebrew/bin/chromium
```

Homebrew applies “quarantine” attribute to downloaded files, need to clear it.

```sh
xattr -cr $(which chromium)
xattr -cr /Applications/Chromium.app
```

Might need to go to `System Preferences` > `Security & Privacy` > `General` tab, and select `Open Anyway`.

https://www.reddit.com/r/MacOS/comments/q9d772/homebrew_chromium_is_damaged_and_cant_be_openend/

Add to `.bash_profile`

```sh
export PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
export PUPPETEER_EXECUTABLE_PATH=`which chromium`
```

## Build Cypress arm64 binary - Cypress 9.5.4

https://github.com/cypress-io/cypress/issues/19908

```sh
cd $HOME/git
git clone https://github.com/cypress-io/cypress
cd cypress
git checkout tags/v9.5.4
yarn
code electron-builder.json
```

Change to

```json
{
  "productName": "Cypress",
  "appId": "com.electron.cypress",
  "target": "zip",
  "mac": {
    "target": {
      "target": "zip",
      "arch": ["x64", "arm64"]
    },
    "identity": null,
    "forceCodeSigning": false,
    "publish": null,
    "hardenedRuntime": true,
    "entitlements": "./scripts/entitlements.mac.inherit.plist",
    "entitlementsInherit": "./scripts/entitlements.mac.inherit.plist",
    "type": "distribution"
  },
  "linux": {
    "target": "dir",
    "executableName": "Cypress"
  },
  "win": {
    "target": "dir"
  },
  "afterPack": "./scripts/after-pack-hook.js"
}
```

```sh
yarn binary-build --platform darwin --version 9.5.4
mkdir -p ~/Library/Caches/Cypress/9.5.4
cp -R build/build/mac-arm64/* ~/Library/Caches/Cypress/9.5.4
```

Note - got an error with the yarn binary-build command - but it seems to work

```txt
It looks like you are running the Cypress binary directly.

This is not the recommended approach, and Cypress may not work correctly.

Please install the cypress NPM package and follow the instructions here:

https://on.cypress.io/installing-cypress
undefined

🔥 deploy error
Error: running project tests failed with: '1' errors.
    at ChildProcess.<anonymous> (/Users/user.name/git/cypress/scripts/binary/smoke.js:106:21)
    at ChildProcess.emit (node:events:527:28)
    at ChildProcess.emit (node:domain:475:12)
    at Process.ChildProcess._handle.onexit (node:internal/child_process:291:12)
error Command failed with exit code 1.
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.
```
